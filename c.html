<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학원 상담 프로그램</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Firebase SDK 임포트
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, doc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        // 전역 변수 설정 (Canvas 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;

        let studentsCollectionRef;
        let schedulesCollectionRef;

        // HTML 요소
        const studentForm = document.getElementById('studentForm');
        const consultationForm = document.getElementById('consultationForm');
        const scheduleForm = document.getElementById('scheduleForm'); // 스케줄 폼 추가
        const studentList = document.getElementById('studentList');
        const studentSelect = document.getElementById('studentSelect');
        const scheduleList = document.getElementById('scheduleList'); // 스케줄 목록 추가
        const loadingIndicator = document.getElementById('loadingIndicator');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const studentStatusMessage = document.getElementById('studentStatusMessage');
        const consultationStatusMessage = document.getElementById('consultationStatusMessage');
        const scheduleStatusMessage = document.getElementById('scheduleStatusMessage');

        // 메시지 표시 함수
        const displayStatus = (element, message, isError = false) => {
            element.textContent = message;
            element.classList.remove('text-green-600', 'text-red-600');
            element.classList.add(isError ? 'text-red-600' : 'text-green-600');
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 3000);
        };

        // 초기화 및 인증
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is not set. Please provide a valid Firebase configuration.");
                displayStatus(studentStatusMessage, "Firebase 설정 오류. 관리자에게 문의하세요.", true);
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `사용자 ID: ${userId}`;
                    studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
                    schedulesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/schedules`);
                    startListeningForStudents();
                    startListeningForSchedules(); // 스케줄 리스너 시작
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in.");
                    userIdDisplay.textContent = "사용자 ID: 로그인 중...";
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        };

        // 학생 목록 실시간 업데이트
        const startListeningForStudents = () => {
            if (!studentsCollectionRef) return;

            loadingIndicator.style.display = 'block';
            const q = query(studentsCollectionRef, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                studentList.innerHTML = '';
                studentSelect.innerHTML = '<option value="">학생을 선택하세요</option>';
                snapshot.forEach((doc) => {
                    const student = doc.data();
                    const studentId = doc.id;

                    // 학생 선택 드롭다운에 추가
                    const option = document.createElement('option');
                    option.value = studentId;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);

                    // 학생 목록에 표시
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                    studentDiv.innerHTML = `
                        <h3 class="text-xl font-bold mb-2">${student.name} (${student.grade}학년)</h3>
                        <p class="text-gray-600 mb-1"><strong>학부모 연락처:</strong> ${student.parentContact}</p>
                        <p class="text-gray-600 mb-1"><strong>특이사항:</strong> ${student.notes}</p>
                        <button onclick="toggleConsultations('${studentId}')" class="mt-2 text-blue-500 hover:text-blue-700 font-semibold">상담 내역 보기</button>
                        <div id="consultation-history-${studentId}" class="mt-4 hidden"></div>
                    `;
                    studentList.appendChild(studentDiv);
                });
                loadingIndicator.style.display = 'none';
            });
        };

        // 스케줄 목록 실시간 업데이트
        const startListeningForSchedules = () => {
            if (!schedulesCollectionRef) return;
            const q = query(schedulesCollectionRef, orderBy('date', 'asc'), orderBy('time', 'asc'));
            onSnapshot(q, (snapshot) => {
                scheduleList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const schedule = doc.data();
                    const scheduleDiv = document.createElement('div');
                    scheduleDiv.className = 'bg-gray-100 p-3 rounded-lg border border-gray-200 mb-2';
                    scheduleDiv.innerHTML = `
                        <p class="font-bold text-gray-800">${schedule.className}</p>
                        <p class="text-sm text-gray-600">${schedule.date} ${schedule.time}</p>
                        <p class="text-sm text-gray-600">${schedule.notes}</p>
                    `;
                    scheduleList.appendChild(scheduleDiv);
                });
            });
        };

        // 학생 추가
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = studentForm.name.value;
            const grade = studentForm.grade.value;
            const parentContact = studentForm.parentContact.value;
            const notes = studentForm.notes.value;

            if (!name || !grade) {
                displayStatus(studentStatusMessage, '이름과 학년을 입력해주세요.', true);
                return;
            }

            try {
                await addDoc(studentsCollectionRef, {
                    name,
                    grade: parseInt(grade),
                    parentContact,
                    notes,
                    createdAt: serverTimestamp()
                });
                displayStatus(studentStatusMessage, '학생이 성공적으로 추가되었습니다.');
                studentForm.reset();
            } catch (e) {
                console.error("학생 추가 중 오류 발생: ", e);
                displayStatus(studentStatusMessage, "학생 추가 중 오류가 발생했습니다.", true);
            }
        });

        // 상담 추가
        consultationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = consultationForm.studentSelect.value;
            const consultationDate = consultationForm.consultationDate.value;
            const consultationNotes = consultationForm.consultationNotes.value;

            if (!studentId || !consultationDate || !consultationNotes) {
                displayStatus(consultationStatusMessage, '모든 항목을 입력해주세요.', true);
                return;
            }

            try {
                const consultationRef = collection(db, `artifacts/${appId}/users/${userId}/students/${studentId}/consultations`);
                await addDoc(consultationRef, {
                    date: consultationDate,
                    notes: consultationNotes,
                    createdAt: serverTimestamp()
                });
                displayStatus(consultationStatusMessage, '상담 내역이 성공적으로 추가되었습니다.');
                consultationForm.reset();
            } catch (e) {
                console.error("상담 내역 추가 중 오류 발생: ", e);
                displayStatus(consultationStatusMessage, "상담 내역 추가 중 오류가 발생했습니다.", true);
            }
        });

        // 스케줄 추가
        scheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const className = scheduleForm.className.value;
            const date = scheduleForm.scheduleDate.value;
            const time = scheduleForm.scheduleTime.value;
            const notes = scheduleForm.scheduleNotes.value;

            if (!className || !date || !time) {
                displayStatus(scheduleStatusMessage, '클래스명, 날짜, 시간을 입력해주세요.', true);
                return;
            }

            try {
                await addDoc(schedulesCollectionRef, {
                    className,
                    date,
                    time,
                    notes,
                    createdAt: serverTimestamp()
                });
                displayStatus(scheduleStatusMessage, '스케줄이 성공적으로 추가되었습니다.');
                scheduleForm.reset();
            } catch (e) {
                console.error("스케줄 추가 중 오류 발생: ", e);
                displayStatus(scheduleStatusMessage, "스케줄 추가 중 오류가 발생했습니다.", true);
            }
        });

        // 상담 내역 보기/숨기기
        window.toggleConsultations = async (studentId) => {
            const historyDiv = document.getElementById(`consultation-history-${studentId}`);
            if (historyDiv.classList.contains('hidden')) {
                historyDiv.innerHTML = '<p class="text-center text-gray-500">불러오는 중...</p>';
                historyDiv.classList.remove('hidden');

                const consultationsRef = collection(db, `artifacts/${appId}/users/${userId}/students/${studentId}/consultations`);
                const q = query(consultationsRef, orderBy('createdAt', 'desc'));
                
                try {
                    const snapshot = await getDocs(q);
                    historyDiv.innerHTML = '';
                    if (snapshot.empty) {
                        historyDiv.innerHTML = '<p class="text-gray-500">등록된 상담 내역이 없습니다.</p>';
                    } else {
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const p = document.createElement('p');
                            p.className = 'border-l-4 border-blue-400 pl-2 mb-2 bg-gray-50 p-2 rounded';
                            p.innerHTML = `<span class="font-semibold text-gray-700">${data.date}</span>: ${data.notes}`;
                            historyDiv.appendChild(p);
                        });
                    }
                } catch (error) {
                    console.error("상담 내역 불러오기 실패:", error);
                    historyDiv.innerHTML = '<p class="text-red-500">상담 내역을 불러오는 중 오류가 발생했습니다.</p>';
                }
            } else {
                historyDiv.classList.add('hidden');
            }
        };
        
        // 초기화 함수 실행
        initFirebase();
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto space-y-8">
        <header class="bg-blue-600 text-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold">학원 상담 프로그램</h1>
            <p class="mt-2 text-blue-100">학생 정보와 상담 내역, 스케줄을 효율적으로 관리하세요.</p>
            <div id="userIdDisplay" class="mt-4 text-sm text-blue-200"></div>
        </header>

        <!-- 학생 추가 섹션 -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">학생 추가</h2>
            <form id="studentForm" class="space-y-4">
                <input type="text" id="name" placeholder="이름" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="grade" placeholder="학년" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="parentContact" placeholder="학부모 연락처 (선택 사항)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="notes" placeholder="특이사항 (선택 사항)" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">학생 추가하기</button>
                <div id="studentStatusMessage" class="mt-2 text-center text-sm font-medium hidden"></div>
            </form>
        </section>

        <!-- 상담 추가 섹션 -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">상담 기록 추가</h2>
            <form id="consultationForm" class="space-y-4">
                <select id="studentSelect" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">학생을 선택하세요</option>
                </select>
                <input type="date" id="consultationDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="consultationNotes" placeholder="상담 내용 기록" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                <button type="submit" class="w-full bg-indigo-500 text-white p-3 rounded-lg font-semibold hover:bg-indigo-600 transition-colors">상담 기록 저장하기</button>
                <div id="consultationStatusMessage" class="mt-2 text-center text-sm font-medium hidden"></div>
            </form>
        </section>

        <!-- 스케줄 추가 섹션 -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">학원 스케줄 관리</h2>
            <form id="scheduleForm" class="space-y-4 mb-6">
                <input type="text" id="className" placeholder="클래스명 (예: 초등 수학)" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                <div class="flex space-x-4">
                    <input type="date" id="scheduleDate" required class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <input type="time" id="scheduleTime" required class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                </div>
                <textarea id="scheduleNotes" placeholder="세부 내용 (선택 사항)" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"></textarea>
                <button type="submit" class="w-full bg-pink-500 text-white p-3 rounded-lg font-semibold hover:bg-pink-600 transition-colors">스케줄 추가하기</button>
                <div id="scheduleStatusMessage" class="mt-2 text-center text-sm font-medium hidden"></div>
            </form>

            <h3 class="text-xl font-semibold text-gray-700 mb-2">예정된 스케줄</h3>
            <div id="scheduleList" class="space-y-3">
                <!-- 스케줄이 여기에 동적으로 추가됩니다 -->
            </div>
        </section>

        <!-- 학생 목록 섹션 -->
        <section class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">학생 목록</h2>
            <div id="loadingIndicator" class="text-center text-gray-500 hidden">
                <p>데이터 불러오는 중...</p>
            </div>
            <div id="studentList" class="space-y-4">
                <!-- 학생 목록이 여기에 동적으로 추가됩니다 -->
            </div>
        </section>
    </div>
</body>
</html>
